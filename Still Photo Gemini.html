<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Still Photo Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #334155;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            background-color: #475569;
            color: #e2e8f0;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 100%;
        }
        .container input, .container select, .container textarea {
            background-color: #64748b;
            color: #e2e8f0;
            border-color: #4a5a6c;
        }
        .container input::placeholder, .container textarea::placeholder {
            color: #94a3b8;
        }
        .container select option {
            background-color: #475569;
        }
        #compiledPrompt {
            min-height: 120px;
        }
        .text-input-group {
            position: relative;
        }
        .clear-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: #ef4444;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            line-height: 1rem;
            cursor: pointer;
            z-index: 10;
        }
        #drop-zone {
            border: 4px dashed #4a5568;
            transition: all 0.2s ease-in-out;
        }
        #drop-zone.drag-over {
            border-color: #4299e1;
            background-color: #2d3748;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-4">Generate a Still Photo</h1>
        <p class="text-center text-gray-300 mb-6">Select from different categories to build a unique prompt. Your selections from a category are replaced when you pick a new one from the same category.</p>
        
        <!-- Image Reference Section -->
        <h2 class="text-2xl font-bold text-center mt-8 mb-4">Add an Image Reference</h2>
        <div id="drop-zone" class="p-8 md:p-12 rounded-lg cursor-pointer flex flex-col items-center justify-center mb-6">
            <svg class="w-16 h-16 text-gray-400 mb-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
            <p class="text-gray-300 font-semibold mb-2">Drag and drop an image here</p>
            <p class="text-gray-500 text-sm mb-4">or click to upload</p>
            <input type="file" id="file-input" class="hidden" accept="image/*">
        </div>
        <div id="image-container" class="mt-8 hidden">
            <img id="preview-image" src="" alt="Dropped Image" class="rounded-lg w-full h-auto shadow-lg border border-gray-700">
        </div>
        
        <div class="flex flex-col gap-4 my-4">
            <div>
                <label for="styleCategorySelect" class="block text-gray-200 font-semibold mb-2">Style Prompts</label>
                <select id="styleCategorySelect" class="w-full p-3 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="" disabled selected>Choose a category...</option>
                </select>
            </div>
            
            <div>
                <label for="themeCategorySelect" class="block text-gray-200 font-semibold mb-2">Theme & Subject</label>
                <select id="themeCategorySelect" class="w-full p-3 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="" disabled selected>Choose a category...</option>
                </select>
            </div>

            <div>
                <label for="promptSelect" class="block text-gray-200 font-semibold mb-2">Select Prompt</label>
                <select id="promptSelect" class="w-full p-3 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-400" disabled>
                    <option value="" disabled selected>Choose a prompt...</option>
                </select>
            </div>

            <div class="text-input-group">
                <label for="compiledPrompt" class="block text-gray-200 font-semibold mb-2">Compiled Prompt</label>
                <textarea id="compiledPrompt" rows="3" class="w-full p-3 rounded-lg border resize-none" placeholder="Your selections will appear here."></textarea>
                <button id="clearBtn" class="clear-btn">Clear</button>
            </div>
        </div>

        <button id="generateBtn" class="w-full bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-600 transition duration-300" disabled>
            Generate Photo
        </button>

        <div id="statusMessage" class="text-center text-gray-400 mt-6 hidden"></div>
        <div id="imageContainer" class="flex justify-center items-center bg-gray-600 rounded-lg overflow-hidden border-2 border-gray-500 mt-6" style="height: 400px;">
            <p id="placeholderText" class="text-gray-400">Your image will appear here.</p>
            <img id="generatedImage" src="" alt="Generated Image" class="hidden w-full h-full object-contain">
        </div>
    </div>

    <script>
        const styleCategorySelect = document.getElementById('styleCategorySelect');
        const themeCategorySelect = document.getElementById('themeCategorySelect');
        const promptSelect = document.getElementById('promptSelect');
        const compiledPrompt = document.getElementById('compiledPrompt');
        const generateBtn = document.getElementById('generateBtn');
        const statusMessage = document.getElementById('statusMessage');
        const generatedImage = document.getElementById('generatedImage');
        const placeholderText = document.getElementById('placeholderText');
        const clearBtn = document.getElementById('clearBtn');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const imageContainer = document.getElementById('image-container');
        const previewImage = document.getElementById('preview-image');

        let selectedPrompts = {};
        const promptsData = {
            "Style": {
                "Composition": [
                    { "Prompt": "A balanced composition following the rule of thirds, with the subject placed on an intersecting line, creating a dynamic yet stable frame." },
                    { "Prompt": "Framed through a foreground element like an archway or window, adding depth and focusing the eye." },
                    { "Prompt": "Strong leading lines from a road or river guide the viewer's eye towards the subject in the distance." },
                    { "Prompt": "A perfectly symmetrical shot, creating a sense of order, formality, and intentionality." },
                    { "Prompt": "A low-angle, full-body shot that makes the subject appear powerful and dominant in their environment." },
                    { "Prompt": "A high-angle shot looking down, making the subject seem small, vulnerable, or insignificant within the scene." },
                    { "Prompt": "A dynamic composition with a dutch angle, tilting the camera to create a sense of unease or disorientation." }
                ],
                "Lighting": [
                    { "Prompt": "Bathed in the warm, soft glow of golden hour lighting, casting long, gentle shadows and creating a serene, cinematic atmosphere." },
                    { "Prompt": "Dramatic backlighting that creates a powerful silhouette of the subject, hiding details and emphasizing their form." },
                    { "Prompt": "Lit by a single, harsh light source from the side (chiaroscuro), creating deep shadows and high contrast for a dramatic, moody effect." },
                    { "Prompt": "Soft, diffused light from an overcast sky or a large window, wrapping the subject in a gentle, flattering light with minimal shadows." },
                    { "Prompt": "Low-key lighting where most of the frame is dark, using a single, motivated light source like a candle or lamp to create mystery." },
                    { "Prompt": "High-key lighting with a bright, clean look, minimizing shadows to create an optimistic, airy, or sterile mood." },
                    { "Prompt": "The scene is lit by the eerie, colorful glow of neon signs at night, casting vibrant, unnatural colors on the subject." }
                ],
                "Emotion & Mood": [
                    { "Prompt": "A melancholic and introspective mood, captured in a quiet portrait with muted, cool colors and a focus on a somber expression." },
                    { "Prompt": "An atmosphere of overwhelming joy and celebration, with vibrant colors, dynamic motion, and genuine, laughing expressions." },
                    { "Prompt": "A tense, suspenseful mood where the character is waiting, with dark shadows, a quiet environment, and a look of anticipation." },
                    { "Prompt": "A feeling of profound solitude and loneliness, depicted by a single small figure in a vast, empty landscape." },
                    { "Prompt": "A powerful and confident mood, shown through a direct, unwavering stare into the camera, strong posture, and bold lighting." },
                    { "Prompt": "A dreamy, ethereal mood with soft focus, pastel colors, and a light, airy atmosphere, creating a sense of fantasy or memory." },
                    { "Prompt": "A gritty, tense, and raw mood, captured with sharp focus, high contrast, and an expression of grim determination." }
                ],
                "Visual Style": [
                    { "Prompt": "A nostalgic visual style with a heavy film grain texture, reminiscent of vintage 35mm photography, with slightly desaturated colors." },
                    { "Prompt": "A high-contrast, black and white photograph that emphasizes shape, shadow, and texture, in the style of Ansel Adams." },
                    { "Prompt": "A vibrant, hyper-realistic style with extremely saturated colors and sharp details, making the scene look almost surreal." },
                    { "Prompt": "A soft-focus, dreamy visual with a shallow depth of field, creating a romantic or whimsical atmosphere with beautiful bokeh." },
                    { "Prompt": "A gritty, cinematic anamorphic widescreen look, with lens flares and a shallow depth of field, shot on Panavision." },
                    { "Prompt": "A clean, minimalist style with a simple color palette and a lot of negative space, focusing on a single subject." },
                    { "Prompt": "A dark, moody, neo-noir style with deep shadows, wet streets reflecting neon lights, and a sense of mystery." }
                ]
            },
            "Theme": {
                "Characters": [
                    { "Prompt": "A photorealistic portrait of a battle-weary Roman legionnaire, his intricate armor showing scratches and dust, standing guard at dusk under a torchlight." },
                    { "Prompt": "An ancient scribe, with ink-stained fingers, hunched over a papyrus scroll in a candle-lit library, deeply focused." },
                    { "Prompt": "A wise, elderly shepherd with a weathered face, leaning on a wooden staff, watching his flock on a vast, sun-drenched hillside." },
                    { "Prompt": "A powerful king on an ornate throne, adorned in gold and jewels, his expression a mixture of authority and weariness." },
                    { "Prompt": "A humble woman in simple, draped robes, drawing water from a stone well at sunrise, her silhouette framed by the morning light." },
                    { "Prompt": "A rugged fisherman with a tangled beard and strong hands, mending his nets on the shore of the Sea of Galilee as waves crash nearby." },
                    { "Prompt": "A high priest in elaborate ceremonial robes, standing before a grand temple altar, surrounded by swirling incense smoke." }
                ],
                "Settings": [
                    { "Prompt": "A wide, cinematic shot of a bustling ancient marketplace in Jerusalem, filled with vibrant textiles, clay pots, and diverse crowds under the hazy afternoon sun." },
                    { "Prompt": "The vast, silent desert at midnight, with countless stars and the Milky Way visible in the night sky, casting a faint glow on the sand dunes." },
                    { "Prompt": "The claustrophobic interior of a sandstone cave, the rough textures of the walls revealed by the flickering light of a single torch." },
                    { "Prompt": "A serene olive grove with ancient, gnarled trees, bathed in the soft, golden light of late afternoon." },
                    { "Prompt": "The opulent interior of a Roman villa, featuring intricate mosaic floors, marble columns, and an open-air courtyard with a fountain." },
                    { "Prompt": "The grand entrance to a pharaoh's tomb, with colossal statues and hieroglyphs carved into the stone, dwarfing human figures." },
                    { "Prompt": "A humble, small dwelling in a Galilean village, constructed from mud-brick and wood, with simple pottery and textiles inside." }
                ],
                "Objects": [
                    { "Prompt": "A macro shot focusing on the intricate details of a clay tablet, with sharp cuneiform script etched into its textured surface, lit by a dramatic side-light." },
                    { "Prompt": "A polished bronze oil lamp, its flame burning brightly and casting a warm, soft light onto a rustic wooden table." },
                    { "Prompt": "A detailed close-up of an unrolled parchment scroll, showing the texture of the material and the elegant, handwritten Hebrew script." },
                    { "Prompt": "A simple woven basket filled with freshly baked loaves of rustic bread and several small, silvery fish." },
                    { "Prompt": "A close-up on a dusty, leather-bound book with ornate metal clasps, its pages yellowed with age." },
                    { "Prompt": "A single, dusty amphora (clay jar), half-buried in the desert sand, hinting at a lost caravan or ancient ruin." },
                    { "Prompt": "A golden, seven-branched candelabrum (menorah) on a stone altar inside a temple, its polished surface reflecting the candlelight." }
                ],
                "Events": [
                    { "Prompt": "An epic landscape shot of a caravan of camels and travelers silhouetted against a brilliant sunrise, crossing vast sand dunes." },
                    { "Prompt": "A crowd of people gathered on a grassy hillside, listening intently to a speaker, their faces illuminated by the setting sun." },
                    { "Prompt": "The monumental construction of the pyramids, with thousands of workers moving massive stone blocks under the harsh Egyptian sun." },
                    { "Prompt": "An intimate scene of a family gathered around a table for a Passover Seder, their faces lit by candlelight as they share a meal." },
                    { "Prompt": "A Roman banquet in a grand hall, with nobles reclining on couches, feasting on exotic foods, and surrounded by opulent decorations." },
                    { "Prompt": "A group of disciples gathered for a final, solemn meal at a long wooden table in a simple, rustic room." },
                    { "Prompt": "A quiet, contemplative moment of prayer in a secluded, moonlit garden filled with ancient olive trees." }
                ]
            }
        };

        // Function to make API call with exponential backoff
        async function fetchWithExponentialBackoff(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) {
                        return response;
                    }
                    console.log(`Rate limit hit. Retrying in ${delay / 1000} seconds...`);
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    console.log(`Request failed. Retrying in ${delay / 1000} seconds...`);
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
        }
        
        // Handles file processing for the drop zone
        function handleFile(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    imageContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                console.log("Not an image file.");
            }
        }

        // Event listeners for the drop zone
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            handleFile(file);
        });

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            handleFile(file);
        });

        function updateCategoryOptions() {
            function populateSelect(selectElement, data) {
                const currentSelection = selectElement.value;
                selectElement.innerHTML = '<option value="" disabled selected>Choose a category...</option>';
                for (const category in data) {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = selectedPrompts[category] ? `✅ ${category}` : category;
                    selectElement.appendChild(option);
                }
                selectElement.value = currentSelection;
            }
            
            populateSelect(styleCategorySelect, promptsData.Style);
            populateSelect(themeCategorySelect, promptsData.Theme);
        }

        function updateButtonState() {
            generateBtn.disabled = compiledPrompt.value.trim().length === 0;
        }

        window.onload = () => {
            updateCategoryOptions();
            updateButtonState();

            // Event listener for the compiled prompt textarea to enable/disable the button
            compiledPrompt.addEventListener('input', updateButtonState);

            clearBtn.addEventListener('click', () => {
                selectedPrompts = {};
                compiledPrompt.value = '';
                updateCategoryOptions();
                updateButtonState();
                promptSelect.innerHTML = '<option value="" disabled selected>Choose a prompt...</option>';
                promptSelect.disabled = true;
                compiledPrompt.placeholder = 'Your selections will appear here.';
                styleCategorySelect.value = '';
                themeCategorySelect.value = '';
                previewImage.src = '';
                imageContainer.classList.add('hidden');
            });
        };

        function handleCategoryChange(selectElement, otherSelectElement, dataObject) {
             promptSelect.innerHTML = '<option value="" disabled selected>Choose a prompt...</option>';
            const selectedCategory = selectElement.value;
            if (selectedCategory) {
                promptSelect.disabled = false;
                otherSelectElement.value = ''; 
                const prompts = dataObject[selectedCategory];
                if (prompts) {
                    prompts.forEach((item, index) => {
                        const option = document.createElement('option');
                        option.value = selectedCategory + '|' + index;
                        option.textContent = item.Prompt;
                        promptSelect.appendChild(option);
                    });
                }
            }
        }

        styleCategorySelect.addEventListener('change', () => handleCategoryChange(styleCategorySelect, themeCategorySelect, promptsData.Style));
        themeCategorySelect.addEventListener('change', () => handleCategoryChange(themeCategorySelect, styleCategorySelect, promptsData.Theme));


        promptSelect.addEventListener('change', () => {
            if (!promptSelect.value) return;
            const [category, index] = promptSelect.value.split('|');
            const selectedPrompt = promptsData.Style[category] ? promptsData.Style[category][index].Prompt : promptsData.Theme[category][index].Prompt;
            
            selectedPrompts[category] = selectedPrompt;

            let currentPrompt = compiledPrompt.value.trim();
            if (currentPrompt.length > 0) {
                compiledPrompt.value = currentPrompt + '. ' + selectedPrompt;
            } else {
                compiledPrompt.value = selectedPrompt;
            }

            updateCategoryOptions();
            updateButtonState();
            styleCategorySelect.value = '';
            themeCategorySelect.value = '';
            promptSelect.innerHTML = '<option value="" disabled selected>Choose a prompt...</option>';
            promptSelect.disabled = true;
        });

        generateBtn.addEventListener('click', async () => {
            const prompt = compiledPrompt.value.trim();
            if (!prompt) {
                statusMessage.textContent = 'Please select a prompt to generate an image.';
                statusMessage.classList.remove('hidden');
                return;
            }

            generatedImage.classList.add('hidden');
            generatedImage.src = '';
            placeholderText.classList.remove('hidden');
            placeholderText.textContent = '';
            statusMessage.classList.remove('hidden');
            statusMessage.textContent = 'Generating image...';

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
            
            // Build the payload with the text prompt and optional image
            const parts = [{ text: prompt }];
            if (previewImage.src) {
                const base64Data = previewImage.src.split(',')[1];
                parts.push({
                    inlineData: {
                        mimeType: "image/jpeg", // Assuming JPEG, but could be dynamic
                        data: base64Data
                    }
                });
            }

            const payload = {
                contents: [{ parts: parts }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE']
                }
            };

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const imagePart = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);

                if (imagePart && imagePart.inlineData && imagePart.inlineData.data) {
                    const base64Data = imagePart.inlineData.data;
                    generatedImage.src = `data:image/jpeg;base64,${base64Data}`;
                    generatedImage.classList.remove('hidden');
                    placeholderText.classList.add('hidden');
                    statusMessage.classList.add('hidden');
                } else {
                    statusMessage.textContent = 'Failed to generate image. Please try a different prompt.';
                }

            } catch (error) {
                console.error('Error generating image:', error);
                statusMessage.textContent = 'An error occurred. Please try again.';
            }
        });
    </script>
</body>
</html>
